# jmeter-logstash

Jmeter JTL parsing with Logstash and elasticsearch

## Features

1. TODO

## Getting Started

This config is tested with ELK version **7.15.1**, but it is not directly dependent by this version it should work with other version 7.xxx (maybe _8.xx_ ).

### Create ElasticSearch stack

1. Create Optional docker network (Called jmeter). If not used remove "--net jmeter " from all following docker command.

```
docker network create jmeter
```

1. Start elastic search container , Or use any Elasticsearch instance you have already installed.

```
docker run --name jmeter-elastic  --net jmeter \
-p 9200:9200 -p 9300:9300 \
-e "ES_JAVA_OPTS=-Xms1024m -Xmx1024m" \
-e "xpack.security.enabled=false" \
-e "discovery.type=single-node" \
docker.elastic.co/elasticsearch/elasticsearch:7.15.1
```

1. Start Kibana and connect it to elastic search Using environnement variable _ELASTICSEARCH_HOSTS_.

```
docker run --name jmeter-kibana  --net jmeter -p 5601:5601 -e "ELASTICSEARCH_HOSTS=http://jmeter-elastic:9200" docker.elastic.co/kibana/kibana:7.15.1
```

## Run Logstash

1. Clone this repository or download it.
2. In the project folder create a folder named 'input' or you can use any input folder in your machine.
3. If you choose to use a different input folder, you should change **"${PWD}/input"** on the following command by your input folder.
4. On the project folder execute the following command, (${PWD} it's the current folder). ${PWD} can be replaced by full path to folder.

```
docker run --rm -it \
-e "ELASTICSEARCH_HOSTS=http://jmeter-elastic:9200"  --net jmeter \
-v ${PWD}/input:/input/ \
-v ${PWD}/config/pipeline:/usr/share/logstash/pipeline/ \
-v ${PWD}/config/settings/logstash.yml:/usr/share/logstash/config/logstash.yml \
-v ${PWD}/config/settings/jvm.options:/usr/share/logstash/config/jvm.options \
docker.elastic.co/logstash/logstash:7.15.1

```

## Parameters

### ElasticSearch

| Environment variables            | Description                                                                                                                                                                               | Default                   |
| -------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------- |
| `ELASTICSEARCH_HOSTS`            | Elasticsearch output configuration [hosts](https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-hosts)                       | http://elasticsearch:9200 |
| `ELASTICSEARCH_INDEX`            | Elasticsearch output configuration [index](https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-index)                       | jmeter-jtl-%{+YYYY.MM.dd} |
| `ELASTICSEARCH_USER`             | Elasticsearch output configuration [user](https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-user)                         |                           |
| `ELASTICSEARCH_PASSWORD`         | Elasticsearch output configuration [password](https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-password)                 |                           |
| `ELASTICSEARCH_HTTP_COMPRESSION` | Elasticsearch output configuration [http_compression](https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-http_compression) | false                     |

### Logstash

| Environment variables     | Description                                                                                                                                                           | Default   |
| ------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| `PROJECT_NAME`            | Project name                                                                                                                                                          | undefined |
| `ENVIRONMENT_NAME`        | Environment name, if not provided will try to extract value from file name ( {test_name}-{environment-name}-{execution_id} )                                          | undefined |
| `TEST_NAME`               | Test name, if not provided will try to extract value from file name ( {test_name}-{environment-name}-{execution_id} or {test_name}-{execution_id} or {test_name})     | undefined |
| `EXECUTION_ID`            | Execution Id, if not provided will try to extract value from file name ( {test_name}-{environment-name}-{execution_id} or {test_name}-{execution_id} )                | undefined |
| `FILE_READ_MODE`          | File input configuration [mode](https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-mode)                                   | tail      |
| `FILE_START_POSITION`     | File input configuration [start_position](https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-start_position)               | end       |
| `FILE_EXIT_AFTER_READ`    | File input configuration [exit_after_read](https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-exit_after_read)             | false     |
| `FILE_COMPLETED_ACTION`   | File input configuration [file_completed_action](https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-file_completed_action) | delete    |
| `sincedb_path`            | File input configuration [file_completed_action](https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-sincedb_path)          | delete    |
| `MISSED_RESPONSE_CODE`    | Default response code when not present in response like on timeout case                                                                                               | 510       |
| `PARSE_LABELS_SPLIT_CHAR` | Char to split label into labels                                                                                                                                       | /         |

## Fields

For csv field see documentation on [CSV Log format](https://jmeter.apache.org/usermanual/listeners.html#csvlogformat).

For additional fields see documentation on [Results file configuration](https://jmeter.apache.org/usermanual/properties_reference.html#results_file_config).

| Environnement variable      | type    | source        | Description                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| --------------------------- | ------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `@timestamp`                | date    | elk           | Insertion time in Elastic search                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `Connect`                   | long    | csv           | time to establish connection                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `IdleTime`                  | long    | csv           | number of milliseconds of 'Idle' time (normally 0)                                                                                                                                                                                                                                                                                                                                                                                               |
| `Latency`                   | long    | csv           | time to first response                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `URL`                       | string  | csv           |                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `allThreads`                | long    | csv           | total number of active threads in all groups                                                                                                                                                                                                                                                                                                                                                                                                     |
| `bytes`                     | long    | csv           | number of bytes in the sample                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `dataType`                  | string  | csv           | e.g. text                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `domain`                    | string  | parsing       | domain name or ip which is extracted from url.                                                                                                                                                                                                                                                                                                                                                                                                   |
| `elapsed`                   | long    | csv           | elapsed - in milliseconds                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `environment`               | string  | input/parsing | Target environment (Ex: dev, stage ..), as input using environment variable or extracted from filename.                                                                                                                                                                                                                                                                                                                                          |
| `executionid`               | string  | input/parsing | Unique id to identify data for a test, as input using environment variable or extracted from filename.                                                                                                                                                                                                                                                                                                                                           |
| `failureMessage`            | string  | csv           |                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `filename`                  | string  | parsing       | csv file name without extension.                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `globalLabel`               | string  | parsing       | Normalized label for subresults, when there redirection (ex 302) jmeter log all redirects requests and the parent one by default (_jmeter.save.saveservice.subresults=false_ to disable), the parent will have the normal label and other subresut will have a suffix like "-xx" when xx is the order number, in this field you will find the original label for all subresult without the number suffix (see field : subresult, redirectLevel ) |
| `grpThreads`                | long    | csv           | number of active threads in this thread group                                                                                                                                                                                                                                                                                                                                                                                                    |
| `host`                      | string  | elk           | hostname of logstash node.                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `label`                     | string  | csv           | sampler label                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `labels`                    | string  | parsing       | List of keywords extracted by splitting label using the char "PARSE_LABELS_SPLIT_CHAR" from environment variable , default to "/"                                                                                                                                                                                                                                                                                                                |
| `path`                      | string  | logstash      | Path of csv file.                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `project`                   | string  | input         | Project name.                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `redirectLevel`             | long    | parsing       | redirect number (see field: _globalLabel_)                                                                                                                                                                                                                                                                                                                                                                                                       |
| `relativetime`              | float   | parsing       | Number of milliseconds from test started. Useful to compare test. this field need to have started test time logged to csv (add this variable name _TESTSTART.MS_ to property _sample_variables_)                                                                                                                                                                                                                                                 |
| `request`                   | string  | parsing       | Request path if Http/s request.                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `responseCode`              | string  | csv           |                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `responseMessage`           | string  | csv           |                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `responseStatus`            | long    | parsing       | Numeric responseCode , if responseCode is not numeric (case on timeout) using value "MISSED_RESPONSE_CODE" from environment variable , default to 510.                                                                                                                                                                                                                                                                                           |
| `sentBytes`                 | long    | csv           | number of bytes sent for the sample.                                                                                                                                                                                                                                                                                                                                                                                                             |
| `subresult`                 | boolean | parsing       | true if sample is a sub result (see field: _globalLabel_)                                                                                                                                                                                                                                                                                                                                                                                        |
| `success`                   | boolean | csv           | true or false.                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `testname`                  | string  | parsing       | Test name, as input using environment variable or extracted from filename.                                                                                                                                                                                                                                                                                                                                                                       |
| `teststart`                 | date    | csv           | Test start time. This field need to have started test time logged to csv (add this variable name _TESTSTART.MS_ to property _sample_variables_)                                                                                                                                                                                                                                                                                                  |
| `threadGrpId`               | long    | parsing       | The number of thread group                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `threadGrpName`             | string  | csv           | The name of thread group                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `threadNumber`              | long    | parsing       | The number of thread (unique in thread group)                                                                                                                                                                                                                                                                                                                                                                                                    |
| `threadName`                | string  | csv           | Thread name, unique on test.                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `timestamp`                 | date    | csv           | Request time.                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `transaction`               | boolean | parsing       | IS Sampler transaction , generated by transaction controller, to identify transaction label should start and and with "\_", the regex used to this is "\_.+\_"                                                                                                                                                                                                                                                                                   |
| `transactionFailingSampler` | long    | parsing       | If sample is transaction, this value represent number of failing sampler.                                                                                                                                                                                                                                                                                                                                                                        |
| `transactionTotalSampler`   | long    | parsing       | If sample is transaction, this value represent count of total sampler.                                                                                                                                                                                                                                                                                                                                                                           |
